<!doctype html>
<html lang="en">

<head>
	<meta content="text/html;charset=utf-8" http-equiv="Content-Type">
	<meta content="utf-8" http-equiv="encoding">
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css" integrity="sha384-B0vP5xmATw1+K9KRQjQERJvTumQW0nPEzvF6L/Z6nronJ3oUOFUFpCjEUQouq2+l" crossorigin="anonymous">
	<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.23/css/jquery.dataTables.css">
	<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/searchbuilder/1.0.1/css/searchBuilder.bootstrap4.min.css"/>
	<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/select/1.3.1/css/select.bootstrap4.min.css"/>
	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.bundle.js"></script>
	<script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.10.23/js/jquery.dataTables.js"></script>
	<!--script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/v/dt/dt-1.10.23/sb-1.0.1/sl-1.3.1/datatables.min.js"></script-->
	<script type="text/javascript" src="https://cdn.datatables.net/searchbuilder/1.0.1/js/dataTables.searchBuilder.min.js"></script>
	<script type="text/javascript" src="https://cdn.datatables.net/searchbuilder/1.0.1/js/searchBuilder.bootstrap4.min.js"></script>
	<script type="text/javascript" src="https://cdn.datatables.net/select/1.3.1/js/dataTables.select.min.js"></script>
	<script type="text/javascript" src="js/store.js"></script>
	<script type="text/javascript" src="js/common.js"></script>
</head>

<body>
<nav class="navbar sticky-top navbar-expand-lg navbar-dark bg-dark">
  <a class="navbar-brand" href="#">Pricelist Scrubber</a>
  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>
  <div class="collapse navbar-collapse" id="navbarNav">
  	<ul class="navbar-nav">
      <li class="nav-item">
        <a class="nav-link" href="/">Dashboard</a>
      </li>
      <li class="nav-item active">
        <a class="nav-link" href="#">Price List</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="#">Part Selector</a>
      </li>
    </ul>
  </div>
</nav>
<div class="alert alert-primary" role="alert">
  Disclaimer: this data may be out of date as it was scraped from PCHub's online pricelist. For PCHub's latest pricelist, visit their <a href="http://pchubpricelist.online">website</a>
</div>
<div class="container">
<h2>PCHUB Data</h2>
<table id="mytable" class="display">
    <thead>
        <tr>
            <th>Category</th>
            <th>Description</th>
			<th>Price</th>
			<th>Availability</th>
        </tr>
    </thead>
    <tbody>
    </tbody>
</table>


<div class="modal" id="chart-modal" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modal-title-price-chart">Price Chart</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
      	<div id="modal-body-dscp"></div>
      	<div id="chart-container">
      	</div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" id="add-to-watchlist">Add to Watchlist</button>
        <button type="button" class="btn btn-primary" id="remove-from-watchlist">Remove from Watchlist</button>
      </div>
    </div>
  </div>
</div>
</div>
<script type="text/javascript">
var table = $('#mytable').DataTable( {
    ajax: '/api/pchub/latest-dt',
	columns: [
        { data: 'category' },
        { data: 'description', 
		  render: function ( data, type, row ) {
                return row.brand + ' ' + row.properties + ' ' + row.description + '<br/> (sku:' + row.sku + ')';
          } 
		},
        { data: 'cashPrice' },
        { data: 'availability' }
    ],
	dom: 'Qlfrtip',
	pageLength: 50
} );


	$('#mytable tbody').on('click', 'tr', function() {
		var data = table.row(this).data();
		getPriceHist(data.sku, function(data, labels, cdata, xdata) {
			$('#chart-modal').on('shown.bs.modal', function(event) {
				var modal = $(this);
				
				var watchlistStore = getWatchlist();
				
				$('#add-to-watchlist, #remove-from-watchlist').unbind('click');
				if (watchlistStore[xdata.sku]) {
					$('#add-to-watchlist').hide();
					$('#remove-from-watchlist').show();
				} else {
					$('#add-to-watchlist').show();
					$('#remove-from-watchlist').hide();
				}
				$("#add-to-watchlist").on("click", function() {
					addToWatchlist(xdata.sku, xdata);
					$('#add-to-watchlist').hide();
					$('#remove-from-watchlist').show();
					alert("Saved to watchlist");
				});
				
				$("#remove-from-watchlist").on("click", function() {
					deleteFromWatchlist(xdata.sku);
					$('#add-to-watchlist').show();
					$('#remove-from-watchlist').hide();
					alert("Removed from watchlist");
				});
				
				$("#chart-container canvas").remove();
				$("#chart-container").append("<canvas height=200 style='width: 100%'></canvas>");
				var canvas = modal.find('#chart-container canvas');
				var ctx = canvas[0].getContext("2d");
				$("#modal-body-dscp").text(xdata.brand + ' ' + xdata.properties + ' ' + xdata.description);
				
				window.myChart = chartData(ctx, labels, cdata);
			});
			$('#chart-modal').modal('show');
		});

	});
</script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js" integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.min.js" integrity="sha384-+YQ4JLhjyBLPDQt//I+STsc9iw4uQqACwlvpslubQzn4u2UU2UFM80nGisd026JF" crossorigin="anonymous"></script>
</body>
</html>