<!doctype html>
<html lang="en">

<head>
	<meta content="text/html;charset=utf-8" http-equiv="Content-Type">
	<meta content="utf-8" http-equiv="encoding">
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css" integrity="sha384-B0vP5xmATw1+K9KRQjQERJvTumQW0nPEzvF6L/Z6nronJ3oUOFUFpCjEUQouq2+l" crossorigin="anonymous">
	<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.23/css/jquery.dataTables.css">
	<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/searchbuilder/1.0.1/css/searchBuilder.bootstrap4.min.css"/>
	<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/select/1.3.1/css/select.bootstrap4.min.css"/>
	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.bundle.js"></script>
	<script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.10.23/js/jquery.dataTables.js"></script>
	<!--script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/v/dt/dt-1.10.23/sb-1.0.1/sl-1.3.1/datatables.min.js"></script-->
	<script type="text/javascript" src="https://cdn.datatables.net/searchbuilder/1.0.1/js/dataTables.searchBuilder.min.js"></script>
	<script type="text/javascript" src="https://cdn.datatables.net/searchbuilder/1.0.1/js/searchBuilder.bootstrap4.min.js"></script>
	<script type="text/javascript" src="https://cdn.datatables.net/select/1.3.1/js/dataTables.select.min.js"></script>
</head>

<body>
<h1>Pricelist Scrubber</h1>

<h2>PCHUB Data</h2>
<table id="mytable" class="display">
    <thead>
        <tr>
            <th>Category</th>
            <th>Description</th>
			<th>Price</th>
			<th>Availability</th>
        </tr>
    </thead>
    <tbody>
    </tbody>
</table>


<div class="modal" id="chart-modal" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Price Chart</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <canvas id="myChart" ></canvas>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<script type="text/javascript">
var table = $('#mytable').DataTable( {
    ajax: '/api/pchub/latest-dt',
	columns: [
        { data: 'category' },
        { data: 'description', 
		  render: function ( data, type, row ) {
                return row.brand + ' ' + row.properties + ' ' + row.description + '<br/> (sku:' + row.sku + ')';
          } 
		},
        { data: 'cashPrice' },
        { data: 'availability' }
    ],
	dom: 'Qlfrtip',
	pageLength: 50
} );

$('#mytable tbody').on('click', 'tr', function () {
	var data = table.row( this ).data();
	$.get( "/api/pchub?sku="+data.sku, function( data ) {
		var cnvs = document.getElementById('myChart');
		cnvs.style.width  = '500px';
		cnvs.style.height = '200px';
		var ctx = cnvs.getContext('2d');
		var labels = [];
		var cdata = [];
		for (var i = 0; i < data.length; i++) {
			var currData = data[i];
			labels.push(new Date(currData.recordedDate).toLocaleDateString("en-US"));
			cdata.push(currData.cashPrice);
		}
		
	      $('#chart-modal').on('shown.bs.modal',function(event){
				var modal = $(this);
				var canvas = modal.find('.modal-body canvas');
				
				var ctx = canvas[0].getContext("2d");
				
		      var myChart = new Chart(ctx, {
		    	    type: 'line',
		    	    data: {
		    	        labels: labels,
		    	        datasets: [{
		    	            label: 'Amount',
		    	            data: cdata,
		    				fill: false,
		    				borderColor: 'rgba(250, 100, 100, 1)',
		    				lineTension: 0,
		    	        }]
		    	    },
		    		options: {
		    	        responsive: true,
		    			maintainAspectRatio: false
		    	    }
		    	});
	      });
      $('#chart-modal').modal('show');
	});
	
} );
</script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js" integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.min.js" integrity="sha384-+YQ4JLhjyBLPDQt//I+STsc9iw4uQqACwlvpslubQzn4u2UU2UFM80nGisd026JF" crossorigin="anonymous"></script>
</body>
</html>